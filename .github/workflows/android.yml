name: ðŸ¤– Android Build & Test

on:
  push:
    branches: [ main, feat/initial-project-setup, fix/build-critical-errors ]
    paths:
      - 'android/**'
      - 'gradle/**'
      - '*.gradle.kts'
  pull_request:
    branches: [ main, feat/initial-project-setup ]
  schedule:
    # Run security checks weekly
    - cron: '0 2 * * 1'

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx4g"
  JAVA_VERSION: '17'

jobs:
  # ============================================================================
  # ðŸ—ï¸ BUILD APK
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Install the Android SDK and required build components
      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: platform-tools, platforms;android-34, build-tools;34.0.0


      - name: ðŸ—ƒï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: âœ… Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: ðŸ—ï¸ Build Debug APK
        run: ./gradlew assembleDebug --build-cache

      - name: ðŸ—ï¸ Build Release APK
        run: ./gradlew assembleRelease --build-cache

      - name: ðŸ“± Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: mr-comic-debug
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 7

      - name: ðŸ“± Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: mr-comic-release
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: ðŸ“Š APK Info
        run: |
          echo "# ðŸ“± APK Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          DEBUG_APK=$(find android/app/build/outputs/apk/debug -name "*.apk" | head -1)
          RELEASE_APK=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          
          if [ -f "$DEBUG_APK" ]; then
            DEBUG_SIZE=$(ls -lh "$DEBUG_APK" | awk '{print $5}')
            echo "âœ… **Debug APK**: $(basename "$DEBUG_APK") ($DEBUG_SIZE)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "$RELEASE_APK" ]; then
            RELEASE_SIZE=$(ls -lh "$RELEASE_APK" | awk '{print $5}')
            echo "âœ… **Release APK**: $(basename "$RELEASE_APK") ($RELEASE_SIZE)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Download APKs from Artifacts section below!**" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸ§ª BASIC TESTS
  # ============================================================================
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Install the Android SDK for running unit tests
      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: platform-tools, platforms;android-34, build-tools;34.0.0


      - name: ðŸ—ƒï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ§ª Run Unit Tests
        run: ./gradlew test --continue

      - name: ðŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/build/test-results/test*/
            **/build/reports/tests/test*/
          retention-days: 7

      - name: ðŸ“‹ Test Summary
        if: always()
        run: |
          echo "# ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if find . -name "TEST-*.xml" -type f | head -1 > /dev/null; then
            echo "âœ… Unit tests completed successfully" >> $GITHUB_STEP_SUMMARY
            TEST_COUNT=$(find . -name "TEST-*.xml" -exec grep -l "testcase" {} \; | wc -l)
            echo "ðŸ“Š **Test files found**: $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # ðŸ”’ SECURITY & DEPENDENCY SCAN
  # ============================================================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: ðŸ“… Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ—ƒï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ” Dependency Vulnerability Check
        run: ./gradlew dependencyCheckAnalyze --continue
        continue-on-error: true

      - name: ðŸ”’ CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: security-and-quality

      - name: ðŸ” Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: ðŸ“ Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            **/build/reports/dependency-check-report.html
            **/build/reports/dependency-check-report.xml
          retention-days: 30

      - name: ðŸ“„ Security Summary
        if: always()
        run: |
          echo "# ðŸ”’ Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security scanning completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check artifacts for detailed vulnerability reports" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸ—ï¸ CODE QUALITY
  # ============================================================================
  quality:
    name: ðŸ—ï¸ Code Quality
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸ“… Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ—ƒï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ—ï¸ Run Detekt Analysis
        run: ./gradlew detekt --continue
        continue-on-error: true

      - name: ðŸ“ Upload Code Quality Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: |
            **/build/reports/detekt/
            **/build/reports/ktlint/
          retention-days: 14

      - name: ðŸ“„ Code Quality Summary
        if: always()
        run: |
          echo "# ðŸ—ï¸ Code Quality Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code quality analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check artifacts for Detekt and other quality reports" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸ INTEGRATION TESTS
  # ============================================================================
  integration-test:
    name: ðŸ Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸ“… Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: platform-tools, platforms;android-34, build-tools;34.0.0

      - name: ðŸ—ƒï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ Run Integration Tests
        run: ./gradlew connectedCheck --continue
        continue-on-error: true

      - name: ðŸ“ Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            **/build/reports/androidTests/
            **/build/outputs/androidTest-results/
          retention-days: 7

      - name: ðŸ“„ Integration Test Summary
        if: always()
        run: |
          echo "# ðŸ Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Integration tests completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check artifacts for detailed test reports" >> $GITHUB_STEP_SUMMARY
  lint:
    name: ðŸ” Lint Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Install the Android SDK for lint checks
      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: platform-tools, platforms;android-34, build-tools;34.0.0

      - name: ðŸ—ƒï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ” Run Android Lint
        run: ./gradlew lint --continue
        continue-on-error: true

      - name: ðŸ“Š Upload Lint Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: |
            **/build/reports/lint-results*.html
            **/build/reports/lint-results*.xml
          retention-days: 7

      - name: ðŸ“‹ Lint Summary
        if: always()
        run: |
          echo "# ðŸ” Lint Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Android Lint analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # âœ… SUCCESS SUMMARY
  # ============================================================================
  success:
    name: âœ… Build Complete
    runs-on: ubuntu-latest
    needs: [build, test, lint, security, quality, integration-test]
    if: always()
    steps:
      - name: ðŸŽ‰ Pipeline Summary
        run: |
          echo "# ðŸŽ‰ Mr.Comic Build Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build APK | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | ${{ needs.security.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Quality | ${{ needs.quality.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Integration | ${{ needs.integration-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "ðŸš€ **APK Files Ready!**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“± Download from Artifacts section" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build Failed**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- APK files (debug & release)" >> $GITHUB_STEP_SUMMARY
          echo "- Test results and coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Lint and code quality reports" >> $GITHUB_STEP_SUMMARY
          echo "- Security vulnerability reports" >> $GITHUB_STEP_SUMMARY