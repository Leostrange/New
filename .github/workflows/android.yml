name: ðŸ¤– Android Build & Test

on:
  push:
    branches: [ main, feat/initial-project-setup, fix/build-critical-errors ]
    paths:
      - 'android/**'
      - 'gradle/**'
      - '*.gradle.kts'
  pull_request:
    branches: [ main, feat/initial-project-setup ]

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx4g"

jobs:
  # ============================================================================
  # ðŸ—ï¸ BUILD APK
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Install the Android SDK and required build components
      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: platform-tools, platforms;android-34, build-tools;34.0.0


      - name: ðŸ—ƒï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: âœ… Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: ðŸ—ï¸ Build Debug APK
        run: ./gradlew assembleDebug --build-cache

      - name: ðŸ—ï¸ Build Release APK
        run: ./gradlew assembleRelease --build-cache

      - name: ðŸ“± Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: mr-comic-debug
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 7

      - name: ðŸ“± Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: mr-comic-release
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: ðŸ“Š APK Info
        run: |
          echo "# ðŸ“± APK Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          DEBUG_APK=$(find android/app/build/outputs/apk/debug -name "*.apk" | head -1)
          RELEASE_APK=$(find android/app/build/outputs/apk/release -name "*.apk" | head -1)
          
          if [ -f "$DEBUG_APK" ]; then
            DEBUG_SIZE=$(ls -lh "$DEBUG_APK" | awk '{print $5}')
            echo "âœ… **Debug APK**: $(basename "$DEBUG_APK") ($DEBUG_SIZE)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "$RELEASE_APK" ]; then
            RELEASE_SIZE=$(ls -lh "$RELEASE_APK" | awk '{print $5}')
            echo "âœ… **Release APK**: $(basename "$RELEASE_APK") ($RELEASE_SIZE)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Download APKs from Artifacts section below!**" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸ§ª BASIC TESTS
  # ============================================================================
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Install the Android SDK for running unit tests
      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: platform-tools, platforms;android-34, build-tools;34.0.0


      - name: ðŸ—ƒï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ§ª Run Unit Tests
        run: ./gradlew test --continue

      - name: ðŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/build/test-results/test*/
            **/build/reports/tests/test*/
          retention-days: 7

      - name: ðŸ“‹ Test Summary
        if: always()
        run: |
          echo "# ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if find . -name "TEST-*.xml" -type f | head -1 > /dev/null; then
            echo "âœ… Unit tests completed successfully" >> $GITHUB_STEP_SUMMARY
            TEST_COUNT=$(find . -name "TEST-*.xml" -exec grep -l "testcase" {} \; | wc -l)
            echo "ðŸ“Š **Test files found**: $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # ðŸ” BASIC LINT
  # ============================================================================
  lint:
    name: ðŸ” Lint Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Install the Android SDK for lint checks
      - name: ðŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: platform-tools, platforms;android-34, build-tools;34.0.0

      - name: ðŸ—ƒï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ” Run Android Lint
        run: ./gradlew lint --continue
        continue-on-error: true

      - name: ðŸ“Š Upload Lint Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: |
            **/build/reports/lint-results*.html
            **/build/reports/lint-results*.xml
          retention-days: 7

      - name: ðŸ“‹ Lint Summary
        if: always()
        run: |
          echo "# ðŸ” Lint Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Android Lint analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # âœ… SUCCESS SUMMARY
  # ============================================================================
  success:
    name: âœ… Build Complete
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: always()
    steps:
      - name: ðŸŽ‰ Pipeline Summary
        run: |
          echo "# ðŸŽ‰ Mr.Comic Build Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Task | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build APK | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "ðŸš€ **APK Files Ready!**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“± Download from Artifacts section" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build Failed**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” Check logs for details" >> $GITHUB_STEP_SUMMARY
          fi