name: ðŸ”’ Security & Dependency Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Sundays at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  # ============================================================================
  # ðŸ” DEPENDENCY VULNERABILITY SCAN
  # ============================================================================
  dependency-scan:
    name: ðŸ” Dependency Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ—ƒï¸ Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ” Gradle Dependency Vulnerability Check
        run: |
          ./gradlew dependencyCheckAnalyze --info --continue
        continue-on-error: true

      - name: ðŸ“‹ Check for Outdated Dependencies
        run: |
          ./gradlew dependencyUpdates --info
          echo "## ðŸ“¦ Dependency Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dependency vulnerability scan completed" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: ðŸ“ˆ Upload Dependency Check Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-reports
          path: |
            **/build/reports/dependency-check-report.html
            **/build/reports/dependencyUpdates/
          retention-days: 30

  # ============================================================================
  # ðŸ›¡ï¸ CODEQL SECURITY ANALYSIS
  # ============================================================================
  codeql-analysis:
    name: ðŸ›¡ï¸ CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    strategy:
      fail-fast: false
      matrix:
        language: ['java-kotlin']
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ—ƒï¸ Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ—ï¸ Build Project for Analysis
        run: |
          ./gradlew assembleDebug --build-cache --no-daemon

      - name: ðŸ›¡ï¸ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

      - name: ðŸ“‹ Security Analysis Summary
        run: |
          echo "## ðŸ›¡ï¸ Security Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CodeQL analysis completed for ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Check Security tab for detailed results" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸ“Š SECRET SCANNING
  # ============================================================================
  secret-scan:
    name: ðŸ“Š Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          base: main
          head: HEAD
          path: ./
          extra_args: --debug --only-verified

      - name: ðŸ” Check for Hardcoded Secrets
        run: |
          echo "## ðŸ” Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          
          # Check for common secret patterns
          SECRET_PATTERNS=(
            "api[_-]?key"
            "secret[_-]?key"
            "password"
            "token"
            "private[_-]?key"
          )
          
          FOUND_SECRETS=false
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -ri "$pattern" android/ --include="*.kt" --include="*.xml" --include="*.properties" | grep -v "//.*$pattern" | grep -v "#.*$pattern"; then
              FOUND_SECRETS=true
              echo "âš ï¸ Potential secret found matching pattern: $pattern" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          if [ "$FOUND_SECRETS" = false ]; then
            echo "âœ… No hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # ðŸ§¹ GRADLE WRAPPER VALIDATION
  # ============================================================================
  wrapper-validation:
    name: ðŸ§¹ Gradle Wrapper Validation
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âœ… Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: ðŸ“‹ Validation Summary
        run: |
          echo "## ðŸ§¹ Gradle Wrapper Validation" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Gradle wrapper is valid and secure" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ðŸ“ˆ LICENSE COMPLIANCE CHECK
  # ============================================================================
  license-check:
    name: ðŸ“ˆ License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ—ƒï¸ Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ” Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ“œ Generate License Report
        run: |
          ./gradlew generateLicenseReport --continue
        continue-on-error: true

      - name: ðŸ“‹ License Summary
        run: |
          echo "## ðŸ“œ License Compliance" >> $GITHUB_STEP_SUMMARY
          echo "âœ… License report generated" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check artifacts for detailed license information" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“ˆ Upload License Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-reports
          path: |
            **/build/reports/dependency-license/
          retention-days: 30

  # ============================================================================
  # ðŸ”„ SECURITY SUMMARY
  # ============================================================================
  security-summary:
    name: ðŸ”„ Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, codeql-analysis, secret-scan, wrapper-validation, license-check]
    if: always()
    steps:
      - name: ðŸ“Š Generate Security Summary
        run: |
          echo "# ðŸ”’ Security Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ CodeQL Analysis | ${{ needs.codeql-analysis.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Secret Scanning | ${{ needs.secret-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§¹ Wrapper Validation | ${{ needs.wrapper-validation.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ˆ License Check | ${{ needs.license-check.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall security status
          if [[ "${{ needs.dependency-scan.result }}" == "success" && 
                "${{ needs.codeql-analysis.result }}" == "success" && 
                "${{ needs.secret-scan.result }}" == "success" && 
                "${{ needs.wrapper-validation.result }}" == "success" ]]; then
            echo "ðŸ›¡ï¸ **Overall Security Status**: âœ… SECURE" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ›¡ï¸ **Overall Security Status**: âš ï¸ REVIEW REQUIRED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Detailed Reports**: Check artifacts and Security tab" >> $GITHUB_STEP_SUMMARY