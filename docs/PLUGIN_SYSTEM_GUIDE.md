# Система плагинов MrComic

## Обзор

Система плагинов MrComic предоставляет мощную и безопасную платформу для расширения функциональности приложения. Плагины работают в изолированной среде (песочнице) и имеют строгую систему разрешений.

## Архитектура

### Основные компоненты

1. **PluginManager** - Основной менеджер жизненного цикла плагинов
2. **PluginSandbox** - Песочница для безопасного выполнения кода
3. **PluginPermissionManager** - Управление разрешениями плагинов
4. **PluginValidator** - Валидация и проверка безопасности плагинов
5. **PluginRepository** - Репозиторий для управления данными плагинов

### Типы плагинов

- **JavaScript** - Плагины на JavaScript (основной тип)
- **Native** - Нативные плагины (в разработке)
- **Hybrid** - Гибридные плагины (JavaScript + Native)

### Категории плагинов

- **READER_ENHANCEMENT** - Улучшение читалки
- **IMAGE_PROCESSING** - Обработка изображений  
- **TRANSLATION** - Перевод
- **EXPORT** - Экспорт
- **UTILITY** - Утилиты
- **THEME** - Темы
- **FORMAT_SUPPORT** - Поддержка форматов
- **INTEGRATION** - Интеграция

## Разработка плагинов

### Структура плагина

```
plugin-name/
├── plugin.json        # Метаданные плагина
├── main.js            # Основной код плагина
├── icon.png           # Иконка плагина (необязательно)
└── README.md          # Документация (необязательно)
```

### plugin.json

```json
{
  \"id\": \"unique-plugin-id\",
  \"name\": \"Название плагина\",
  \"version\": \"1.0.0\",
  \"author\": \"Автор\",
  \"description\": \"Описание плагина\",
  \"category\": \"IMAGE_PROCESSING\",
  \"type\": \"JAVASCRIPT\",
  \"permissions\": [
    \"READ_FILES\",
    \"WRITE_FILES\"
  ],
  \"dependencies\": [],
  \"configurable\": true,
  \"main\": \"main.js\"
}
```

### Основной код плагина (main.js)

```javascript
class MyPlugin {
    constructor() {
        this.name = 'My Plugin';
        this.version = '1.0.0';
        this.init();
    }
    
    init() {
        if (typeof window.MrComicPlugin !== 'undefined') {
            window.MrComicPlugin.log('Plugin initialized');
            this.registerCommands();
        }
    }
    
    registerCommands() {
        window.plugin = {
            executeCommand: (command, params) => {
                return this.handleCommand(command, params);
            }
        };
    }
    
    handleCommand(command, params) {
        switch (command) {
            case 'my_command':
                return this.myFunction(params);
            default:
                throw new Error(`Unknown command: ${command}`);
        }
    }
    
    myFunction(params) {
        // Логика плагина
        return {
            success: true,
            data: 'result'
        };
    }
}

// Инициализация плагина
new MyPlugin();
```

## API плагинов

### Глобальный объект MrComicPlugin

```javascript
window.MrComicPlugin = {
    id: 'plugin-id',
    permissions: ['READ_FILES', 'WRITE_FILES'],
    
    // Логирование
    log(message),
    
    // Проверка разрешений
    hasPermission(permission),
    
    // Выполнение системных команд
    executeSystemCommand(command, params),
    
    // Работа с данными приложения
    getAppData(key),
    
    // Работа с данными плагина
    setPluginData(key, value),
    getPluginData(key)
};
```

### Разрешения плагинов

- **READ_FILES** - Чтение файлов
- **WRITE_FILES** - Запись файлов
- **NETWORK_ACCESS** - Доступ к сети
- **CAMERA_ACCESS** - Доступ к камере
- **STORAGE_ACCESS** - Доступ к хранилищу
- **SYSTEM_SETTINGS** - Изменение настроек системы
- **READER_CONTROL** - Управление читалкой
- **UI_MODIFICATION** - Изменение интерфейса

## Безопасность

### Песочница

Все плагины выполняются в изолированной среде с ограниченным доступом к:
- Файловой системе
- Сети
- Системным функциям
- Другим плагинам

### Валидация

Перед установкой все плагины проходят проверку:
- Размер файла (макс. 10 МБ)
- Синтаксис кода
- Безопасность кода
- Наличие обязательных файлов

### Запрещенные конструкции

- `eval()`
- `Function()`
- `document.cookie`
- `localStorage`
- `fetch()`
- `XMLHttpRequest`
- Node.js модули

## Установка и управление

### Установка плагина

1. Через файловый менеджер (загрузка .js или .zip файла)
2. Через магазин плагинов (в разработке)
3. Программная установка через API

### Жизненный цикл плагина

1. **Установка** - Копирование файлов, валидация, сохранение в БД
2. **Активация** - Загрузка в песочницу, проверка разрешений
3. **Выполнение** - Обработка команд и событий
4. **Деактивация** - Остановка выполнения, очистка ресурсов
5. **Удаление** - Удаление файлов и данных из БД

### UI управления

Экран управления плагинами включает:
- Список установленных плагинов
- Переключатели активации/деактивации
- Кнопки настройки и удаления
- Статус и информацию о плагинах
- Диалоги запроса разрешений

## Примеры плагинов

### 1. Плагин улучшения изображений

Автоматическое улучшение качества изображений комиксов с помощью различных алгоритмов обработки.

**Возможности:**
- Повышение резкости
- Улучшение контраста
- Шумоподавление
- Цветокоррекция

### 2. Плагин переводчика

Автоматический перевод текста в комиксах с поддержкой OCR и множества языков.

**Возможности:**
- Распознавание текста (OCR)
- Перевод на различные языки
- Наложение переводов на изображение
- Кэширование переводов

## Интеграция с приложением

### Навигация

Добавление экрана плагинов в главную навигацию:

```kotlin
// В NavGraph
composable(\"plugins\") {
    PluginsScreen(
        onNavigateBack = { navController.popBackStack() }
    )
}
```

### Вызов функций плагинов

```kotlin
// Выполнение команды плагина
viewModel.executePluginCommand(
    pluginId = \"image-enhancer\",
    command = \"enhance_image\",
    params = mapOf(
        \"imagePath\" to \"/path/to/image.jpg\",
        \"options\" to mapOf(\"sharpenStrength\" to 0.7)
    )
)
```

## Отладка и тестирование

### Логирование

Все сообщения плагинов выводятся в Android Log с тегом `Plugin[plugin-id]`.

### Тестирование плагинов

1. Создание тестовых плагинов
2. Проверка в изолированной среде
3. Валидация безопасности
4. Тестирование интеграции

## Расширение системы

### Добавление новых типов плагинов

1. Расширение enum `PluginType`
2. Добавление поддержки в `PluginManager`
3. Реализация загрузчика для нового типа

### Добавление новых разрешений

1. Расширение enum `PluginPermission`
2. Обновление описаний разрешений
3. Реализация проверок в соответствующих модулях

## Производительность

### Оптимизации

- Ленивая загрузка плагинов
- Кэширование результатов
- Ограничение ресурсов выполнения
- Пул WebView для JavaScript плагинов

### Мониторинг

- Время выполнения команд
- Использование памяти
- Количество активных плагинов
- Статистика ошибок

## Планы развития

1. **Магазин плагинов** - Централизованная платформа для распространения
2. **Нативные плагины** - Поддержка плагинов на Kotlin/Java
3. **Плагины тем** - Кастомизация внешнего вида
4. **API расширения** - Больше возможностей для плагинов
5. **Автообновление** - Автоматическое обновление плагинов