# Реализация пакетной обработки страниц

## Обзор

Данная документация описывает реализацию системы пакетной обработки страниц в проекте Mr.Comic. Система позволяет обрабатывать несколько страниц комиксов последовательно, автоматизируя процессы OCR и перевода.

## Архитектура

Система пакетной обработки состоит из двух основных компонентов:

1. **BatchProcessor** - основной класс для управления пакетной обработкой страниц
2. **BatchProcessingIntegration** - интеграционный слой для связи с пользовательским интерфейсом

### BatchProcessor

`BatchProcessor` отвечает за:
- Создание и управление пакетными задачами
- Последовательную обработку страниц в пакете
- Отслеживание прогресса и статистики
- Обработку ошибок и восстановление после сбоев
- Приостановку, возобновление и отмену задач

### BatchProcessingIntegration

`BatchProcessingIntegration` отвечает за:
- Предоставление пользовательского интерфейса для управления пакетными задачами
- Визуализацию прогресса и статуса задач
- Интеграцию с системами OCR и перевода
- Обработку пользовательского ввода

## Функциональные возможности

### Создание пакетных задач

Система позволяет создавать пакетные задачи с указанием:
- Названия задачи
- Списка страниц для обработки
- Движка OCR и его параметров
- Движка перевода и его параметров
- Флага автоматического запуска

```javascript
const batchId = batchProcessor.createBatch({
  name: 'Обработка манги',
  pages: [...],
  ocrOptions: {
    engineId: 'tesseract',
    language: 'ja'
  },
  translationOptions: {
    engineId: 'google-translate',
    sourceLanguage: 'ja',
    targetLanguage: 'ru'
  },
  autoStart: true
});
```

### Управление пакетными задачами

Система предоставляет методы для управления пакетными задачами:
- `processBatch(batchId)` - запуск обработки
- `pauseCurrentBatch()` - приостановка обработки
- `resumeCurrentBatch()` - возобновление обработки
- `cancelCurrentBatch()` - отмена обработки

### Отслеживание прогресса

Система отправляет события о прогрессе обработки:
- `batch:created` - создание пакетной задачи
- `batch:start` - начало обработки
- `batch:progress` - прогресс обработки
- `batch:complete` - завершение обработки
- `batch:error` - ошибка обработки
- `batch:paused` - приостановка обработки
- `batch:resumed` - возобновление обработки
- `batch:cancelled` - отмена обработки
- `task:complete` - завершение обработки страницы

### Статистика

Система собирает статистику о пакетной обработке:
- Общее количество пакетных задач
- Количество завершенных задач
- Количество неудачных задач
- Общее количество страниц
- Количество обработанных страниц
- Количество неудачных страниц
- Общее время OCR
- Общее время перевода
- Среднее время OCR на страницу
- Среднее время перевода на страницу

## Пользовательский интерфейс

Пользовательский интерфейс пакетной обработки включает:

1. **Список пакетных задач** - отображает все созданные пакетные задачи с их статусом и прогрессом
2. **Форма создания пакетной задачи** - позволяет создать новую пакетную задачу
3. **Элементы управления задачами** - кнопки для запуска, приостановки, возобновления и отмены задач
4. **Индикаторы прогресса** - визуальное отображение прогресса обработки

## Интеграция с другими системами

Система пакетной обработки интегрируется с:

1. **Системой OCR** - для распознавания текста на страницах
2. **Системой перевода** - для перевода распознанного текста
3. **Системой событий** - для обмена информацией между компонентами
4. **Системой логирования** - для записи информации о процессе обработки
5. **Системой отображения прогресса** - для визуализации прогресса обработки

## Оптимизация производительности

Для оптимизации производительности система использует:

1. **Последовательную обработку** - страницы обрабатываются последовательно, чтобы не перегружать систему
2. **Оценку времени выполнения** - система оценивает оставшееся время на основе статистики
3. **Приоритизацию задач** - задачи обрабатываются в порядке их создания
4. **Обработку ошибок** - система продолжает работу даже при ошибках на отдельных страницах

## Обработка ошибок

Система обрабатывает следующие типы ошибок:

1. **Ошибки OCR** - проблемы при распознавании текста
2. **Ошибки перевода** - проблемы при переводе текста
3. **Ошибки файловой системы** - проблемы при чтении/записи файлов
4. **Ошибки сети** - проблемы при взаимодействии с внешними API
5. **Ошибки пользовательского ввода** - некорректные параметры

При возникновении ошибки система:
- Логирует информацию об ошибке
- Отправляет событие об ошибке
- Продолжает обработку следующих страниц (если возможно)
- Обновляет статус задачи

## Примеры использования

### Пример 1: Создание и запуск пакетной задачи

```javascript
// Создаем экземпляр процессора пакетной обработки
const batchProcessor = new BatchProcessor({
  eventEmitter,
  logger,
  config,
  ocrEngine,
  translationEngine
});

// Инициализируем процессор
batchProcessor.initialize();

// Создаем пакетную задачу
const batchId = batchProcessor.createBatch({
  name: 'Обработка манги',
  pages: [...],
  ocrOptions: {
    engineId: 'tesseract',
    language: 'ja'
  },
  translationOptions: {
    engineId: 'google-translate',
    sourceLanguage: 'ja',
    targetLanguage: 'ru'
  },
  autoStart: true
});
```

### Пример 2: Отслеживание прогресса

```javascript
// Подписываемся на события прогресса
eventEmitter.on('batch:progress', (data) => {
  const { processId, progress, currentItem, totalItems, remainingTime } = data;
  console.log(`Прогресс: ${progress}%, страница ${currentItem}/${totalItems}, осталось ${formatTime(remainingTime)}`);
});

// Подписываемся на события завершения
eventEmitter.on('batch:complete', (data) => {
  const { processId, results } = data;
  console.log(`Задача ${processId} завершена. Обработано ${results.completedPages}/${results.totalPages} страниц за ${formatTime(results.totalTime)}`);
});
```

### Пример 3: Управление задачами

```javascript
// Приостановка задачи
batchProcessor.pauseCurrentBatch();

// Возобновление задачи
batchProcessor.resumeCurrentBatch();

// Отмена задачи
batchProcessor.cancelCurrentBatch();
```

## Заключение

Система пакетной обработки страниц предоставляет удобный и гибкий инструмент для автоматизации процессов OCR и перевода в проекте Mr.Comic. Она позволяет обрабатывать большие объемы страниц с минимальным участием пользователя, отслеживать прогресс и управлять процессом обработки.

Система спроектирована с учетом расширяемости и может быть легко интегрирована с другими компонентами приложения. Она также предоставляет богатый API для программного управления и отслеживания процесса обработки.
