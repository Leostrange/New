#!/bin/bash

echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° MrComic..."

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… consumer-rules.pro Ñ„Ð°Ð¹Ð»Ð¾Ð²
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… consumer-rules.pro Ñ„Ð°Ð¹Ð»Ð¾Ð²..."

modules=("core-analytics" "feature-themes" "core-domain")

for module in "${modules[@]}"; do
    if [ ! -f "android/$module/consumer-rules.pro" ]; then
        echo "# Consumer ProGuard rules for $module" > "android/$module/consumer-rules.pro"
        echo "# Add module-specific ProGuard rules here" >> "android/$module/consumer-rules.pro"
        echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ android/$module/consumer-rules.pro"
    fi
done

# Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Lint Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² build.gradle.kts Ñ„Ð°Ð¹Ð»Ð°Ñ…
echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Lint Ð¾ÑˆÐ¸Ð±Ð¾Ðº..."

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ lint ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð² build.gradle.kts
add_lint_config() {
    local file="$1"
    if [ -f "$file" ]; then
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ lint ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
        if ! grep -q "lint {" "$file"; then
            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ lint ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾ÑÐ»Ðµ android { Ð±Ð»Ð¾ÐºÐ°
            sed -i '/android {/a\
    lint {\
        disable += "NullSafeMutableLiveData"\
    }' "$file"
            echo "âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° lint ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð² $file"
        else
            echo "â„¹ï¸  Lint ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð² $file"
        fi
    fi
}

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ lint ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð²Ð¾ Ð²ÑÐµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸
android_modules=("app" "core" "core-analytics" "core-data" "core-domain" "core-model" "core-reader" "core-ui" "feature-library" "feature-ocr" "feature-onboarding" "feature-reader" "feature-settings" "feature-themes" "shared")

for module in "${android_modules[@]}"; do
    build_file="android/$module/build.gradle.kts"
    if [ -f "$build_file" ]; then
        add_lint_config "$build_file"
    fi
done

# Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ BookmarkEntity - Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ°
echo "ðŸ—„ï¸  Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ BookmarkEntity..."

bookmark_file="android/core-data/src/main/java/com/example/core/data/database/BookmarkEntity.kt"
if [ -f "$bookmark_file" ]; then
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ Index
    if ! grep -q "import androidx.room.Index" "$bookmark_file"; then
        sed -i '/import androidx.room.ForeignKey/a import androidx.room.Index' "$bookmark_file"
    fi
    
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑ Ð² Entity Ð°Ð½Ð½Ð¾Ñ‚Ð°Ñ†Ð¸ÑŽ
    if ! grep -q "indices = \[\[Index" "$bookmark_file"; then
        sed -i 's/foreignKeys = \[/foreignKeys = [\n    ],\n    indices = [\n        Index(value = ["comicId"])\n    ]/' "$bookmark_file"
        sed -i 's/],\n    indices = \[/,\n    indices = [/' "$bookmark_file"
    fi
    
    echo "âœ… Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½ BookmarkEntity Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑÐ°"
fi

# Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… Divider Ð½Ð° HorizontalDivider
echo "ðŸŽ¨ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… Divider..."

# Ð¤Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
divider_files=(
    "android/feature-settings/src/main/java/com/example/feature/settings/ui/SettingsScreen.kt"
    "android/feature-library/src/main/java/com/example/feature/library/ui/LibraryScreen.kt"
)

for file in "${divider_files[@]}"; do
    if [ -f "$file" ]; then
        # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Divider Ð½Ð° HorizontalDivider
        sed -i 's/Divider(/HorizontalDivider(/g' "$file"
        echo "âœ… Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½ $file"
    fi
done

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .gitignore Ð´Ð»Ñ build Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .gitignore..."

if [ ! -f ".gitignore" ]; then
    cat > .gitignore << EOF
# Built application files
*.apk
*.aar
*.ap_
*.aab

# Files for the ART/Dalvik VM
*.dex

# Java class files
*.class

# Generated files
bin/
gen/
out/
#  Uncomment the following line in case you need and you don't have the release build type files in your app
# release/

# Gradle files
.gradle/
build/

# Local configuration file (sdk path, etc)
local.properties

# Proguard folder generated by Eclipse
proguard/

# Log Files
*.log

# Android Studio Navigation editor temp files
.navigation/

# Android Studio captures folder
captures/

# IntelliJ
*.iml
.idea/workspace.xml
.idea/tasks.xml
.idea/gradle.xml
.idea/assetWizardSettings.xml
.idea/dictionaries
.idea/libraries
# Android Studio 3 in .gitignore file.
.idea/caches
.idea/modules.xml
# Comment next line if keeping position of elements in Navigation Editor is desired for your project
.idea/navEditor.xml

# Keystore files
# Uncomment the following lines if you do not want to check your keystore files in.
#*.jks
#*.keystore

# External native build folder generated in Android Studio 2.2 and later
.externalNativeBuild
.cxx/

# Google Services (e.g. APIs or Firebase)
# google-services.json

# Freeline
freeline.py
freeline/
freeline_project_description.json

# fastlane
fastlane/report.xml
fastlane/Preview.html
fastlane/screenshots
fastlane/test_output
fastlane/readme.md

# Version control
vcs.xml

# lint
lint/intermediates/
lint/generated/
lint/outputs/
lint/tmp/
# lint/reports/

# Android Profiling
*.hprof

# Detekt
reports/
EOF
    echo "âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ .gitignore"
fi

echo "ðŸŽ‰ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo ""
echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: ./gradlew clean"
echo "2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: ./gradlew build"
echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚: PROJECT_ERROR_ANALYSIS_REPORT.md"
echo ""
echo "âš ï¸  ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ: ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:"
echo "- ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ñ ExoPlayer Ð½Ð° Media3"
echo "- Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²"
echo "- ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ¸Ñ… API"